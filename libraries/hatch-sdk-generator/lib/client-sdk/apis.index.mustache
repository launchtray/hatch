import {DependencyContainer} from '@launchtray/tsyringe-async';
{{#apiInfo}}
{{#apis}}
{{#operations}}
import {
  AuthForwarding{{classFilename}},
  Remote{{classFilename}},
} from './{{classFilename}}';
{{/operations}}
{{/apis}}

import {
  {{#apis}}
  {{#operations}}
  {{classFilename}}BaseUrlInjectionToken,
  {{classFilename}}InjectionToken,
  {{/operations}}
  {{/apis}}
} from '../runtime';

// Use this to register APIs client-side, whether from a browser-side app or a dependent service
const registerRemoteApis = (
  container: DependencyContainer,
  baseUrl?: string,
  getToken?: (apiName: string) => string | symbol,
) => {
  {{#apis}}
  {{#operations}}
  container.registerInstance({{classFilename}}BaseUrlInjectionToken, baseUrl ?? '');
  container.register(
    getToken?.('{{classFilename}}') ?? {{classFilename}}InjectionToken,
    Remote{{classFilename}},
  );
  {{/operations}}
  {{/apis}}
};

const registerAuthForwardingApis = (
  container: DependencyContainer,
  baseUrl?: string,
  getToken?: (apiName: string) => string | symbol,
) => {
  const portString = process.env.PORT ?? process.env.HATCH_BUILDTIME_PORT;
  let port: number;
  if (portString != null) {
    port = parseInt(portString, 10);
  } else {
    port = 3000;
  }
  {{#apis}}
  {{#operations}}
  container.registerInstance({{classFilename}}BaseUrlInjectionToken, baseUrl ?? `http://localhost:${port}`);
  container.register(
    getToken?.('{{classFilename}}') ?? {{classFilename}}InjectionToken,
    AuthForwarding{{classFilename}},
  );
  {{/operations}}
  {{/apis}}
};

// Use this to register APIs server-side for the service implementing the API
const registerLocalApis = registerAuthForwardingApis;

export {
  registerLocalApis,
  registerAuthForwardingApis,
  registerRemoteApis,
  {{#apis}}
  {{#operations}}
  AuthForwarding{{classFilename}},
  Remote{{classFilename}},
  {{/operations}}
  {{/apis}}
};
{{/apiInfo}}